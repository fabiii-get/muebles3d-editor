<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor de Muebles Avanzado</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f0f0f0; text-align: center; }
    #tools { padding: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button, input[type="file"] {
      margin: 5px; padding: 8px 12px; font-size: 14px;
    }
    canvas { border: 2px solid #333; margin-top: 10px; cursor: crosshair; }
  </style>
</head>
<body>
  <h2>Editor de Diseño de Muebles</h2>
  <div id="tools">
    <input type="file" id="imgLoader" accept="image/*" />
    <button onclick="setTool('line')">Línea</button>
    <button onclick="setTool('rect')">Rectángulo</button>
    <button onclick="setTool('text')">Texto</button>
    <button onclick="setTool('move')">Mover</button>
    <button onclick="setTool('erase')">Borrar</button>
    <button onclick="download()">Descargar</button>
  </div>
  <canvas id="canvas" width="1000" height="600"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let tool = "line";
    let drawing = false;
    let startX, startY;
    let image = new Image();
    let elements = [];
    let selected = null;

    document.getElementById("imgLoader").addEventListener("change", e => {
      const reader = new FileReader();
      reader.onload = function(evt) {
        image.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
          redraw();
        };
        image.src = evt.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    function setTool(t) {
      tool = t;
      selected = null;
    }

    canvas.addEventListener("mousedown", e => {
      startX = e.offsetX;
      startY = e.offsetY;
      if (tool === "move") {
        selected = elements.find(el => inside(startX, startY, el));
      } else {
        drawing = true;
      }
    });

    canvas.addEventListener("mouseup", e => {
      if (!drawing) return;
      drawing = false;
      const endX = e.offsetX;
      const endY = e.offsetY;
      const newEl = { type: tool, x1: startX, y1: startY, x2: endX, y2: endY, text: "" };

      if (tool === "line" || tool === "rect") {
        elements.push(newEl);
      } else if (tool === "text") {
        const txt = prompt("Texto:");
        if (txt) {
          newEl.text = txt;
          newEl.type = "text";
          elements.push(newEl);
        }
      } else if (tool === "erase") {
        elements = elements.filter(el => !inside(endX, endY, el));
      }
      redraw();
    });

    canvas.addEventListener("mousemove", e => {
      if (tool === "move" && selected) {
        const dx = e.offsetX - startX;
        const dy = e.offsetY - startY;
        selected.x1 += dx; selected.y1 += dy;
        selected.x2 += dx; selected.y2 += dy;
        startX = e.offsetX;
        startY = e.offsetY;
        redraw();
      }
    });

    function inside(x, y, el) {
      return x > Math.min(el.x1, el.x2) && x < Math.max(el.x1, el.x2)
          && y > Math.min(el.y1, el.y2) && y < Math.max(el.y1, el.y2);
    }

    function redraw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (image.src) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      elements.forEach(el => {
        ctx.lineWidth = 2;
        if (el.type === "line") {
          ctx.strokeStyle = "red";
          ctx.beginPath();
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
          ctx.stroke();
        } else if (el.type === "rect") {
          ctx.strokeStyle = "blue";
          ctx.strokeRect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
        } else if (el.type === "text") {
          ctx.fillStyle = "green";
          ctx.font = "16px Arial";
          ctx.fillText(el.text, el.x1, el.y1);
        }
      });
    }

    function download() {
      const link = document.createElement("a");
      link.download = "plano_mueble.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }
  </script>
</body>
</html>
